{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
  #map {
    width: 100%;
    height: 500px;
    margin-top: 10px;
  }

  #countdownTimer {
    width: 100%;
    height: 30px;
    font-size: xx-large;
    background-color: aquamarine;
    color: black;
    display: flex;
    align-items: center;
    justify-content: center;
  }
</style>
{% endblock %}

{% block content %}

<div class="container p">
  <div class="card">
    <div class="card-body">
      <div class="row">
        <div class="col-md-9">
          <h2>Couple Network</h2>
          <div id="map"></div>
        </div>
        <div class="col-md-3">
          <h2>Countdown</h2>
          <div id="countdownTimer" style="height: 20vh;"></div>
          <div class="row align-items-center" style="height: 60vh;">
            <img src="{% static '/images/time.svg' %}" alt="time" class="img-fluid mx-auto d-block " loading="lazy"
              style="height: 60vh;" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% if profile %}
<div class="container profile-container" id="locations">
  <div class="card">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <dl class="row">
            <dt class="col-sm-4"><strong>Location One:</strong></dt>
            <dd class="col-sm-8" id="location_one">{{ profile.location_one }}</dd>

            <dt class="col-sm-4"><strong>Location Two:</strong></dt>
            <dd class="col-sm-8" id="location_two">{{ profile.location_two }}</dd>
          </dl>
        </div>
      </div>
      <p><strong>When you guys will meet:</strong><span id="countDown">{{ profile.datetime_field }}</span></p>
    </div>
  </div>
  <div class="mt-4">
    <a href="{% url 'edit_profile' %}" class="btn btn-warning mr-2">Edit Profile</a>
    <a href="{% url 'delete_profile' %}" class="btn btn-danger">Delete Account</a>
  </div>
</div>
{% else %}
<div class="container mt-5 mb-5">
  <div class="alert alert-warning" role="alert">
    User profile not found.
  </div>
</div>
{% endif %}

{% for prof in profiles %}
<div class="container profile-container latitude" style="display: none;">
  <div class="card">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <dl class="row">
            <dt class="col-sm-4"><strong>Location One:</strong></dt>
            <dd class="col-sm-8" id="location_one_latitude">{{ prof.location_one_latitude }}</dd>
            <dd class="col-sm-8" id="location_one_longitude">{{ prof.location_one_longitude }}</dd>

            <dt class="col-sm-4"><strong>Location Two:</strong></dt>
            <dd class="col-sm-8" id="location_two_latitude">{{ prof.location_two_latitude }}</dd>
            <dd class="col-sm-8" id="location_two_longitude">{{ prof.location_two_longitude }}</dd>
          </dl>
        </div>
      </div>
    </div>
  </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
<!-- <script src="{% static 'home/js/script.js' %}"></script> -->
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var map = L.map('map').setView([0, 0], 2); // Set initial coordinates and zoom level

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    var mylocation = document.getElementById('locations');
    if (mylocation) {

      var locationOne = document.getElementById('location_one').innerHTML;
      var locationTwo = document.getElementById('location_two').innerHTML;

      // Fetch coordinates for locationOne
      $.get(location.protocol + '//nominatim.openstreetmap.org/search?format=json&q=' + locationOne, function (data) {
        var lat1 = data[0].lat;
        var lon1 = data[0].lon;
        var marker1 = L.marker([lat1, lon1]).addTo(map);

        // Fetch coordinates for locationTwo
        $.get(location.protocol + '//nominatim.openstreetmap.org/search?format=json&q=' + locationTwo, function (data) {
          var lat2 = data[0].lat;
          var lon2 = data[0].lon;
          var marker2 = L.marker([lat2, lon2]).addTo(map);

          // Create a Polyline from locationOne to locationTwo
          var polyline = L.polyline([[lat1, lon1], [lat2, lon2]], { color: 'red' }).addTo(map);

          // Fit the map to the bounds of the markers and the polyline
          var bounds = L.latLngBounds([marker1.getLatLng(), marker2.getLatLng()]);
          map.fitBounds(bounds);
        });
      });
    }

    // Loop over each profile container
    document.querySelectorAll('.latitude').forEach(function (container) {
      // Find location elements within the container
      var locationOneLatElement = container.querySelector('#location_one_latitude');
      var locationOneLonElement = container.querySelector('#location_one_longitude');
      var locationTwoLatElement = container.querySelector('#location_two_latitude');
      var locationTwoLonElement = container.querySelector('#location_two_longitude');

      // Check if all elements are found
      if (locationOneLatElement && locationOneLonElement && locationTwoLatElement && locationTwoLonElement) {
        // Extract latitude and longitude values
        var locationOneLat = locationOneLatElement.innerText;
        var locationOneLon = locationOneLonElement.innerText;
        var locationTwoLat = locationTwoLatElement.innerText;
        var locationTwoLon = locationTwoLonElement.innerText;

        // Convert latitude and longitude values to floats
        var locationOneLatLng = [parseFloat(locationOneLat), parseFloat(locationOneLon)];
        var locationTwoLatLng = [parseFloat(locationTwoLat), parseFloat(locationTwoLon)];

        // Add markers to the map
        var marker1 = L.marker(locationOneLatLng).addTo(map)
          .bindPopup('Location One: ' + locationOneLatLng).openPopup();
        var marker2 = L.marker(locationTwoLatLng).addTo(map)
          .bindPopup('Location Two: ' + locationTwoLatLng).openPopup();

        // Create a Polyline from locationOne to locationTwo
        var polyline = L.polyline([[locationOneLat, locationOneLon], [locationTwoLat, locationTwoLon]], { color: 'blue' }).addTo(map);
      } else {
        console.error('One or more location elements not found in the container:', container);
      }
    });

    // Get the scheduled date from the HTML element
    var scheduledDateStr = document.getElementById('countDown').innerHTML.trim(); // Remove leading/trailing whitespaces

    // Preprocess the date string to remove the period after the month abbreviation and convert "p.m." to "PM"
    scheduledDateStr = scheduledDateStr.replace('.', '').replace('p.m.', 'PM');

    // Parse the scheduled date string into a Date object
    var scheduledDate = new Date(scheduledDateStr);

    // Function to update the countdown
    function updateCountdown() {
      var now = new Date();
      var difference = scheduledDate - now;

      // Check if the scheduled date has passed
      if (difference <= 0) {
        clearInterval(timer);
        document.getElementById('countdownTimer').innerHTML = 'Scheduled date has passed';
        return;
      }

      var days = Math.floor(difference / (1000 * 60 * 60 * 24));
      var hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      var minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
      var seconds = Math.floor((difference % (1000 * 60)) / 1000);

      var countdown = days + "d " + hours + "h " + minutes + "m " + seconds + "s";
      document.getElementById('countdownTimer').innerHTML = countdown;
    }

    // Initial call to update countdown
    updateCountdown();

    // Update countdown every second
    var timer = setInterval(updateCountdown, 1000);

  });
</script>
{% endblock %}