{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<style>
    #map {
        width: 100%;
        height: 500px;
        margin-top: 10px;
    }

    #countdownTimer {
        width: 100%;
        height: 25px;
        font-size: xx-large;
        background-color: aquamarine;
        color: black;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}

<div class="container p">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-9">
                    <h2>Couple Network</h2>
                    <div id="map"></div>
                </div>
                <div class="col-md-3">
                    <h2>Countdown</h2>
                    <div id="countdownTimer" style="height: 20vh;"></div>
                    <div class="row align-items-center" style="height: 60vh;">
                        <img src="{% static '/images/time.svg' %}" alt="time" class="img-fluid mx-auto d-block "
                            loading="lazy" style="height: 60vh;" />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% for prof in profiles %}
<div class="container profile-container latitude" style="display: none;">
    <div class="card">
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <dl class="row">
                        <dt class="col-sm-4"><strong>Location One:</strong></dt>
                        <dd class="col-sm-8" id="location_one_latitude">{{ prof.location_one_latitude }}</dd>
                        <dd class="col-sm-8" id="location_one_longitude">{{ prof.location_one_longitude }}</dd>

                        <dt class="col-sm-4"><strong>Location Two:</strong></dt>
                        <dd class="col-sm-8" id="location_two_latitude">{{ prof.location_two_latitude }}</dd>
                        <dd class="col-sm-8" id="location_two_longitude">{{ prof.location_two_longitude }}</dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
</div>
{% endfor %}

{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var map = L.map('map').setView([0, 0], 2);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        document.querySelectorAll('.latitude').forEach(function (container) {
            var locationOneLatElement = container.querySelector('#location_one_latitude');
            var locationOneLonElement = container.querySelector('#location_one_longitude');
            var locationTwoLatElement = container.querySelector('#location_two_latitude');
            var locationTwoLonElement = container.querySelector('#location_two_longitude');

            if (locationOneLatElement && locationOneLonElement && locationTwoLatElement && locationTwoLonElement) {
                var locationOneLat = locationOneLatElement.innerText;
                var locationOneLon = locationOneLonElement.innerText;
                var locationTwoLat = locationTwoLatElement.innerText;
                var locationTwoLon = locationTwoLonElement.innerText;

                var locationOneLatLng = [parseFloat(locationOneLat), parseFloat(locationOneLon)];
                var locationTwoLatLng = [parseFloat(locationTwoLat), parseFloat(locationTwoLon)];

                var marker1 = L.marker(locationOneLatLng).addTo(map)
                    .bindPopup('Location One: ' + locationOneLatLng).openPopup();
                var marker2 = L.marker(locationTwoLatLng).addTo(map)
                    .bindPopup('Location Two: ' + locationTwoLatLng).openPopup();

                var polyline = L.polyline([[locationOneLat, locationOneLon], [locationTwoLat, locationTwoLon]], { color: 'blue' }).addTo(map);
            } else {
                console.error('One or more location elements not found in the container:', container);
            }
        });

        var scheduledDateStr = document.getElementById('countDown').innerHTML.trim(); // Remove leading/trailing whitespaces

        scheduledDateStr = scheduledDateStr.replace('.', '').replace('p.m.', 'PM').replace('a.m.', ' AM');

        var scheduledDate = new Date(scheduledDateStr);

        function updateCountdown() {
            var now = new Date();
            var difference = scheduledDate - now;

            if (difference <= 0) {
                clearInterval(timer);
                document.getElementById('countdownTimer').innerHTML = 'Scheduled date has passed';
                return;
            }

            var days = Math.floor(difference / (1000 * 60 * 60 * 24));
            var hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            var minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((difference % (1000 * 60)) / 1000);

            var countdown = days + "d " + hours + "h " + minutes + "m " + seconds + "s";
            document.getElementById('countdownTimer').innerHTML = countdown;
        }

        updateCountdown();

        var timer = setInterval(updateCountdown, 1000);

    });
</script>
{% endblock %}