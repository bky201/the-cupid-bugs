{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'home/css/profile.css' %}">
{% endblock %}


{% block page_header %}
{% with active_page='profile' %}
{{ block.super }}
{% endwith %}
{% endblock %}

{% block content %}
<div class="container profile-form">
  <div class="row justify-content-center">
    <div class="col-md-8">
      <div class="card shadow-lg p-5">
        <h1 class="display-4 text-danger text-center pb-3"> Create your profile </h1>
        <form method="post" id="profile-form">
          {% csrf_token %}
          <div class="form-group">
            <label for="name_one" class="form-label">Your Name <span class="text-danger">*</span></label>
            {{ form.name_one }}
          </div>
          <div class="form-group">
            <label for="name_two" class="form-label">Partner's Name <span class="text-danger">*</span></label>
            {{ form.name_two }}
          </div>
          <div class="form-group">
            <label for="location_one" class="form-label">Your Location <span class="text-danger">*</span></label>
            {{ form.location_one }}
          </div>
          <input type="hidden" name="location_one_latitude" id="id_location_one_latitude" value="">
          <input type="hidden" name="location_one_longitude" id="id_location_one_longitude" value="">
          <div class="form-group">
            <label for="location_two" class="form-label">Partner's Location <span class="text-danger">*</span></label>
            {{ form.location_two }}
          </div>
          <input type="hidden" name="location_two_latitude" id="id_location_two_latitude" value="">
          <input type="hidden" name="location_two_longitude" id="id_location_two_longitude" value="">
          <div class="form-group">
            <label for="status" class="form-label">Status</label>
            {{ form.status }}
          </div>
          <div class="form-group">
            <label for="datetime_field" class="form-label">Next Meeting Date/Time <span
                class="text-danger">*</span></label>
            {{ form.datetime_field }}
          </div>

          <button type="submit" class="btn btn-success">Save</button>
        </form>
      </div>
    </div>
  </div>
</div>
{% endblock %}


{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
    var form = document.getElementById('profile-form');

    // Function to convert location to coordinates and update hidden input fields
    function updateCoordinates(locationField, latField, lonField) {
      var location = locationField.value;
      // Fetch coordinates for the location
      $.get(location.protocol + '//nominatim.openstreetmap.org/search?format=json&q=' + location, function (data) {
        var lat = data[0].lat;
        var lon = data[0].lon;
        // Update the latitude and longitude fields
        $(latField).val(lat);
        $(lonField).val(lon);
      }).fail(function () {
        // Handle error if the AJAX request fails
        console.error('Failed to retrieve coordinates.');
      });
    }

    // Update coordinates when location fields change
    $('#id_location_one').on('change', function () {
      updateCoordinates(this, '#id_location_one_latitude', '#id_location_one_longitude');
    });

    $('#id_location_two').on('change', function () {
      updateCoordinates(this, '#id_location_two_latitude', '#id_location_two_longitude');
    });

    // Prevent form submission and convert locations to coordinates when submitted
    form.addEventListener('submit', function (event) {
      event.preventDefault(); // Prevent the form from submitting normally
      // Get the values of location_one and location_two
      var locationOne = form.elements['location_one'].value;
      var locationTwo = form.elements['location_two'].value;
      // Call a function to convert locations to coordinates
      convertLocationToCoordinates(locationOne, locationTwo);
    });

    // Function to submit the form after coordinates are updated
    function convertLocationToCoordinates(locationOne, locationTwo) {
      // Fetch coordinates for locationOne
      $.get(location.protocol + '//nominatim.openstreetmap.org/search?format=json&q=' + locationOne, function (data) {
        var lat1 = data[0].lat;
        var lon1 = data[0].lon;
        // Set the retrieved coordinates in the hidden input fields for location_one
        $('#id_location_one_latitude').val(lat1);
        $('#id_location_one_longitude').val(lon1);
        // Fetch coordinates for locationTwo
        $.get(location.protocol + '//nominatim.openstreetmap.org/search?format=json&q=' + locationTwo, function (data) {
          var lat2 = data[0].lat;
          var lon2 = data[0].lon;
          // Set the retrieved coordinates in the hidden input fields for location_two
          $('#id_location_two_latitude').val(lat2);
          $('#id_location_two_longitude').val(lon2);
          // Submit the form
          form.submit();
        });
      }).fail(function () {
        // Handle error if the AJAX request fails
        console.error('Failed to retrieve coordinates.');
      });
    }
  });
</script>
{% endblock %}